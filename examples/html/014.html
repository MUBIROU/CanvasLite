<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>014 Cards</title>
    <script src="https://cdn.rawgit.com/TakashiNishimura/ToileJS/master/toile_test.js"></script>
    <script>
        addEventListener("load", load_window, false);

        function load_window() {
            _isMove = false;
            _choiceBitmap = undefined;
            _disX = _disY = 0;
            _mouseX = _mouseY = 0;
            _webfont = "../ttf/LCDPHONE.TTF";

            //Canvas
            _canvas = new toile.Canvas("myCanvas");
            _canvas.addEventListener("enterframe", enterframe_canvas);
            _canvas.addEventListener("mousemove", mousemove_canvas);
            _canvas.enabledMouseMove(true);
            _canvas.isBorder(true)
            _canvas.fps = 30;

            //Bitmap
            for (let i = 0; i < 52; i++) { //52æžš
                var _bitmap = new toile.Bitmap("../png/card.png");
                _canvas.addChild(_bitmap);

                _bitmap.name = "bitmap" + i;
                _bitmap.x = (_canvas.width - 100) * Math.random();
                _bitmap.y = (_canvas.height - 150) * Math.random();
                _bitmap.regX = 50;
                _bitmap.regY = 75;

                _bitmap.addEventListener("mousedown", mousedown_bitmap);
                _bitmap.addEventListener("mouseup", mouseup_bitmap);
                _bitmap.addEventListener("mouseupoutside", mouseup_bitmap);

            }

            //DEBUG
            _textMouseX = new toile.Text("0");
            _textMouseY = new toile.Text("0");
            _textDisX = new toile.Text("0");
            _textDisY = new toile.Text("0");

            _textMouseX = _textMouseY = _textDisX = _textDisY = 50;

            _textMouseX.y = 50;
            _textMouseY.y = 100;
            _textDisX.y = 150;
            _textDisY.y = 200;

            //_textMouseX.addWebFont("font01", _webfont, "truetype");
            //_textMouseY.addWebFont("font01", _webfont, "truetype");
            //_textDisX.addWebFont("font01", _webfont, "truetype");
            //_textDisY.addWebFont("font01", _webfont, "truetype");

            _textMouseX.font = _textMouseY.font = _textDisX.font = _textDisY.font = "font01";
            _textMouseX.size = _textMouseY.size = _textDisX.size = _textDisY.size = 30;

            _canvas.addChild(_textMouseX);
            _canvas.addChild(_textMouseY);
            _canvas.addChild(_textDisX);
            _canvas.addChild(_textDisY);
        }

        enterframe_canvas = (_canvas) => {
            if (_isMove) {
                _choiceBitmap.x = _mouseX - _disX;
                _choiceBitmap.y = _mouseY - _disY;
            }

            //DEBUG
            _textMouseX.text = _mouseX;
            _textMouseY.text = _mouseY;
            _textDisX.text = _disX;
            _textDisY.text = _disY;

            _canvas.drawScreen();
        }

        mousedown_bitmap = (_bitmap) => {
            console.log("mouseDown: " + _bitmap.name);
            _canvas.setDepthIndex(_bitmap, _canvas.getDepthMax());
            _canvas.stopMouseDownEvent();
            _isMove = true;
            _choiceBitmap = _bitmap;

            _disX = _canvas.mouseX - _bitmap.x;
            _disY = _canvas.mouseY - _bitmap.y;
        }

        mouseup_bitmap = (_bitmap) => {
            console.log("mouseUp: " + _bitmap.name);
            _canvas.stopMouseUpEvent();
            _isMove = false;
            _choiceBitmap = undefined;
        }

        mousemove_canvas = (_canvas) => {
            _mouseX = _canvas.mouseX;
            _mouseY = _canvas.mouseY;
        }
    </script>
    <style>
        body {
            background: #fff;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <canvas id="myCanvas" width="600" height="600"></canvas>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>013 あやつり人形 with CanvasLiteJS</title>
        <script src="https://vvestvillage.github.io/CanvasLiteJS/canvaslite.min.js"></script>
        <script>
            addEventListener("load", load_window, false);

            function load_window() {
                _canvas = new canvaslite.Canvas("myCanvas");
                _canvas.addEventListener("enterframe", enterframe_canvas); 	_canvas.enabledContextMenu(false);
                _canvas.addEventListener("mousedown", mousedown_canvas);
                _canvas.enabledContextMenu(false);
                _canvas.isBorder(true);

                //=========
                // 人形制作
                //=========
                _posX = 200;
                _posY = 100;

                //頭
                _atama = new ShakeContainer();
                _atama.name = "atama";
                _atama_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _atama_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _atama.addChild(_atama_a);
                _atama.addChild(_atama_b);
                _atama.addChild(new canvaslite.Bitmap("../png/atama.png"));
                _atama.width = 173;
                _atama.height = 71;
                _atama.regX = _atama.width / 2;
                _atama.regY = _atama.height / 2;
                _atama_a.x = 70;
                _atama_a.y = 60;
                _atama_b.x = 90;
                _atama_b.y = 60;
                _atama_a.regX = _atama_a.regY = 5;
                _atama_b.regX = _atama_b.regY = 5;
                _atama.x = _posX + 35;
                _atama.y = _posY;
                _canvas.addChild(_atama);

                //右目
                _meR = new ShakeContainer();
                _meR.name = "meR";
                _meR.addChild(new canvaslite.Bitmap("../png/meR.png"));
                _meR.width = 42;
                _meR.height = 49;
                _meR.regX = _meR.width / 2;
                _meR.regY = _meR.height / 2;
                _meR_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _meR.addChild(_meR_a);
                _meR_a.x = 23;
                _meR_a.y = 3;
                _meR_a.regX = _meR_a.regY = 5;
                _meR.x = _posX + 30 + 35;
                _meR.y = _posY + 68;
                _canvas.addChild(_meR);

                //左目
                _meL = new ShakeContainer();
                _meL.name = "meL";
                _meL.addChild(new canvaslite.Bitmap("../png/meL.png"));
                _meL.width = 46;
                _meL.height = 49;
                _meL.regX = _meL.width / 2;
                _meL.regY = _meL.height / 2;
                _meL_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _meL_a.regX = _meL_a.regY = 5;
                _meL.addChild(_meL_a);
                _meL_a.x = 7;
                _meL_a.y = 6;
                _meL.x = _posX + 96 + 35;
                _meL.y = _posY + 65;
                _canvas.addChild(_meL);

                //顎
                _ago = new ShakeContainer();
                _ago.name = "ago";
                _ago_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _ago_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _ago_c = new canvaslite.Bitmap("../png/puppetPoint.png");
                _ago_a.regX = _ago_a.regY = 5;
                _ago_b.regX = _ago_b.regY = 5;
                _ago_c.regX = _ago_c.regY = 5;
                _ago.addChild(_ago_a);
                _ago.addChild(_ago_b);
                _ago.addChild(_ago_c);
                _ago.addChild(new canvaslite.Bitmap("../png/ago.png"));
                _ago.width = 90;
                _ago.height = 31;
                _ago.regX = _ago.width / 2;
                _ago.regY = _ago.height / 2;
                _ago_a.x = 25;
                _ago_a.y = -2;
                _ago_b.x = 53;
                _ago_b.y = -3;
                _ago_c.x = 41;
                _ago_c.y = 23;
                _ago.x = _posX + 38 + 35;
                _ago.y = _posY + 113;
                _canvas.addChild(_ago);

                //胸
                _mune = new ShakeContainer();
                _mune.name = "mune";
                _mune_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _mune_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _mune_c = new canvaslite.Bitmap("../png/puppetPoint.png");
                _mune_d = new canvaslite.Bitmap("../png/puppetPoint.png");
                _mune_e = new canvaslite.Bitmap("../png/puppetPoint.png");
                _mune_a.regX = _mune_a.regY = 5;
                _mune_b.regX = _mune_b.regY = 5;
                _mune_c.regX = _mune_c.regY = 5;
                _mune_d.regX = _mune_d.regY = 5;
                _mune_e.regX = _mune_e.regY = 5;
                _mune.addChild(_mune_a);
                _mune.addChild(_mune_b);
                _mune.addChild(_mune_c);
                _mune.addChild(_mune_d);
                _mune.addChild(_mune_e);
                _mune.addChild(new canvaslite.Bitmap("../png/mune.png"));
                _mune.width = 243;
                _mune.height = 143;
                _mune.regX = _mune.width / 2;
                _mune.regY = _mune.height / 2;
                _mune_a.x = 114
                _mune_a.y = -1;
                _mune_b.x = 17
                _mune_b.y = 41;
                _mune_c.x = 219
                _mune_c.y = 28;
                _mune_d.x = 92
                _mune_d.y = 134;
                _mune_e.x = 135
                _mune_e.y = 133;
                _mune.x = _posX;
                _mune.y = _posY + 153;
                _canvas.addChild(_mune);

                //右ひじ
                _hijiR = new ShakeContainer();
                _hijiR.name = "hijiR";
                _hijiR_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hijiR_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hijiR_a.regX = _hijiR_a.regY = 5;
                _hijiR_b.regX = _hijiR_b.regY = 5;
                _hijiR.addChild(_hijiR_a);
                _hijiR.addChild(_hijiR_b);
                _hijiR.addChild(new canvaslite.Bitmap("../png/hijiHiza.png"));
                _hijiR.width = 33;
                _hijiR.height = 30;
                _hijiR.regX = _hijiR.width / 2;
                _hijiR.regY = _hijiR.height / 2;
                _hijiR_a.x = 11;
                _hijiR_a.y = -4;
                _hijiR_b.x = 13;
                _hijiR_b.y = 24;
                _hijiR.x = _posX + 6;
                _hijiR.y = _posY + 211;
                _canvas.addChild(_hijiR);

                //左ひじ
                _hijiL = new ShakeContainer();
                _hijiL.name = "hijiL";
                _hijiL_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hijiL_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hijiL_a.regX = _hijiL_a.regY = 5;
                _hijiL_b.regX = _hijiL_b.regY = 5;
                _hijiL.addChild(_hijiL_a);
                _hijiL.addChild(_hijiL_b);
                _hijiL.addChild(new canvaslite.Bitmap("../png/hijiHiza.png"));
                _hijiL.width = 33;
                _hijiL.height = 30;
                _hijiL.regX = _hijiL.width / 2;
                _hijiL.regY = _hijiL.height / 2;
                _hijiL_a.x = 11;
                _hijiL_a.y = -4;
                _hijiL_b.x = 12;
                _hijiL_b.y = 24;
                _hijiL.x = _posX + 208;
                _hijiL.y = _posY + 198;
                _canvas.addChild(_hijiL);

                //右手
                _teR = new ShakeContainer();
                _teR.name = "teR";
                _teR_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _teR_a.regX = _teR_a.regY = 5;
                _teR.addChild(_teR_a);
                _teR.addChild(new canvaslite.Bitmap("../png/te.png"));
                _teR.width = 41;
                _teR.height = 40;
                _teR.regX = _teR.width / 2;
                _teR.regY = _teR.height / 2;
                _teR_a.x = 15;
                _teR_a.y = -3;
                _teR.x = _posX + 4;
                _teR.y = _posY + 251 + 50;
                _canvas.addChild(_teR);
                
                //左手
                _teL = new ShakeContainer();
                _teL.name = "teL";
                _teL_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _teL_a.regX = _teL_a.regY = 5;
                _teL.addChild(_teL_a);
                _teL.addChild(new canvaslite.Bitmap("../png/te.png"));
                _teL.width = 41;
                _teL.height = 40;
                _teL.regX = _teL.width / 2;
                _teL.regY = _teL.height / 2;
                _teL_a.x = 15;
                _teL_a.y = -3;
                _teL.x = _posX + 205;
                _teL.y = _posY + 238 + 55;
                _canvas.addChild(_teL);

                //腰
                _koshi = new ShakeContainer();
                _koshi.name = "koshi";
                _koshi_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _koshi_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _koshi_c = new canvaslite.Bitmap("../png/puppetPoint.png");
                _koshi_d = new canvaslite.Bitmap("../png/puppetPoint.png");
                _koshi_a.regX = _koshi_a.regY = 5;
                _koshi_b.regX = _koshi_b.regY = 5;
                _koshi_c.regX = _koshi_c.regY = 5;
                _koshi_d.regX = _koshi_d.regY = 5;
                _koshi.addChild(_koshi_a);
                _koshi.addChild(_koshi_b);
                _koshi.addChild(_koshi_c);
                _koshi.addChild(_koshi_d);
                _koshi.addChild(new canvaslite.Bitmap("../png/koshi.png"));
                _koshi.width = 99;
                _koshi.height = 37;
                _koshi.regX = _koshi.width / 2;
                _koshi.regY = _koshi.height / 2;
                _koshi_a.x = 22;
                _koshi_a.y = -2;
                _koshi_b.x = 64;
                _koshi_b.y = -3;
                _koshi_c.x = 22;
                _koshi_c.y = 26;
                _koshi_d.x = 64;
                _koshi_d.y = 28;
                _koshi.x = _posX + 71;
                _koshi.y = _posY + 305;
                _canvas.addChild(_koshi);

                //右ひざ
                _hizaR = new ShakeContainer();
                _hizaR.name = "hizaR";
                _hizaR_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hizaR_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hizaR_a.regX = _hizaR_a.regY = 5;
                _hizaR_b.regX = _hizaR_b.regY = 5;
                _hizaR.addChild(_hizaR_a);
                _hizaR.addChild(_hizaR_b);
                _hizaR.addChild(new canvaslite.Bitmap("../png/hijiHiza.png"));
                _hizaR.width = 33;
                _hizaR.height = 30;
                _hizaR.regX = _hizaR.width / 2;
                _hizaR.regY = _hizaR.height / 2;
                _hizaR_a.x = 12;
                _hizaR_a.y = -4;
                _hizaR_b.x = 13;
                _hizaR_b.y = 24;
                _hizaR.x = _posX + 81;
                _hizaR.y = _posY + 351;
                _canvas.addChild(_hizaR);

                //左ひざ
                _hizaL = new ShakeContainer();
                _hizaL.name = "hizaL";
                _hizaL_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hizaL_b = new canvaslite.Bitmap("../png/puppetPoint.png");
                _hizaL_a.regX = _hizaL_a.regY = 5;
                _hizaL_b.regX = _hizaL_b.regY = 5;
                _hizaL.addChild(_hizaL_a);
                _hizaL.addChild(_hizaL_b);
                _hizaL.addChild(new canvaslite.Bitmap("../png/hijiHiza.png"));
                _hizaL.width = 33;
                _hizaL.height = 30;
                _hizaL.regX = _hizaL.width / 2;
                _hizaL.regY = _hizaL.height / 2;
                _hizaL_a.x = 12;
                _hizaL_a.y = -4;
                _hizaL_b.x = 13;
                _hizaL_b.y = 24;
                _hizaL.x = _posX + 124;
                _hizaL.y = _posY + 351;
                _canvas.addChild(_hizaL);

                //右足
                _ashiR = new ShakeContainer();
                _ashiR.name = "ashiR";
                _ashiR_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _ashiR_a.regX = _ashiR_a.regY = 5;
                _ashiR.addChild(_ashiR_a);
                _ashiR.addChild(new canvaslite.Bitmap("../png/ashiR.png"));
                _ashiR.width = 85;
                _ashiR.height = 35;
                _ashiR.regX = _ashiR.width / 2;
                _ashiR.regY = _ashiR.height / 2;
                _ashiR_a.x = 59;
                _ashiR_a.y = -1;
                _ashiR.x = _posX + 35;
                _ashiR.y = _posY + 391;
                _canvas.addChild(_ashiR);

                //左足
                _ashiL = new ShakeContainer();
                _ashiL.name = "ashiL";
                _ashiL_a = new canvaslite.Bitmap("../png/puppetPoint.png");
                _ashiL_a.regX = _ashiL_a.regY = 5;
                _ashiL.addChild(_ashiL_a);
                _ashiL.addChild(new canvaslite.Bitmap("../png/ashiL.png"));
                _ashiL.width = 90;
                _ashiL.height = 35;
                _ashiL.regX = _ashiL.width / 2;
                _ashiL.regY = _ashiL.height / 2;
                _ashiL_a.x = 17;
                _ashiL_a.y = 1;
                _ashiL.x = _posX + 121;
                _ashiL.y = _posY + 388;
                _canvas.addChild(_ashiL);

                _containerArray = [
                    _atama, _meR, _meL, _ago, _mune,
                    _hijiR, _hijiL, _teR, _teL, _koshi,
                    _hizaR, _hizaL, _ashiR, _ashiL
                ]

                //各Containerの最初の位置を保存
                for (let i in _containerArray) {
                    _containerArray[i].savePos();
                }

                _lineArray = undefined;
                createLine();
            }

            enterframe_canvas = (_canvas) => {
                //Container
                for (let i in _containerArray) {
                    var _theContainer = _containerArray[i];
                    _theContainer.count += 0.3;
                    _theContainer.moveX *= 0.9;
                    _theContainer.moveY *= 0.9;
                    _theContainer.limitR *= 0.9;
                    _theContainer.x = _theContainer.originX + _theContainer.moveX * Math.sin(_theContainer.count);
                    _theContainer.y = _theContainer.originY + _theContainer.moveY * Math.sin(_theContainer.count);
                    _theContainer.rotate = _theContainer.limitR * Math.sin(_theContainer.count);
                }

                createLine();

                _canvas.drawScreen();
            }

            mousedown_canvas = (_canvas) => {
                for (let i in _containerArray) {
                    _containerArray[i].move(_canvas.mouseX, _canvas.mouseY);
                }
            }

            //============
            // Create Line
            //============
            createLine = () => {
                if (_lineArray != undefined) {
                    for (let i in _lineArray) {
                        _canvas.deleteChild(_lineArray[i]);
                    }
                }

                //頭⇔顎①
                _line1 = new canvaslite.Line(
                    _atama_a.globalX + 5,
                    _atama_a.globalY + 5,
                    _ago_a.globalX + 5,
                    _ago_a.globalY + 5
                )

                //頭⇔顎②
                _line2 = new canvaslite.Line(
                    _atama_b.globalX + 5,
                    _atama_b.globalY + 5,
                    _ago_b.globalX + 5,
                    _ago_b.globalY + 5
                )

                //頭⇔目①
                _line3 = new canvaslite.Line(
                    _atama_a.globalX + 5,
                    _atama_a.globalY + 5,
                    _meR_a.globalX + 5,
                    _meR_a.globalY + 5
                )

                //頭⇔目②
                _line4 = new canvaslite.Line(
                    _atama_b.globalX + 5,
                    _atama_b.globalY + 5,
                    _meL_a.globalX + 5,
                    _meL_a.globalY + 5
                )

                //顎⇔胸
                _line5 = new canvaslite.Line(
                    _ago_c.globalX + 5,
                    _ago_c.globalY + 5,
                    _mune_a.globalX + 5,
                    _mune_a.globalY + 5
                )

                //胸⇔ひじ①
                _line6 = new canvaslite.Line(
                    _mune_b.globalX + 5,
                    _mune_b.globalY + 5,
                    _hijiR_a.globalX + 5,
                    _hijiR_a.globalY + 5
                )

                //胸⇔ひじ②
                _line7 = new canvaslite.Line(
                    _mune_c.globalX + 5,
                    _mune_c.globalY + 5,
                    _hijiL_a.globalX + 5,
                    _hijiL_a.globalY + 5
                )

                //ひじ⇔手①
                _line8 = new canvaslite.Line(
                    _hijiR_b.globalX + 5,
                    _hijiR_b.globalY + 5,
                    _teR_a.globalX + 5,
                    _teR_a.globalY + 5
                )

                //ひじ⇔手②
                _line9 = new canvaslite.Line(
                    _hijiL_b.globalX + 5,
                    _hijiL_b.globalY + 5,
                    _teL_a.globalX + 5,
                    _teL_a.globalY + 5
                )

                //胸⇔腰①
                _line10 = new canvaslite.Line(
                    _mune_d.globalX + 5,
                    _mune_d.globalY + 5,
                    _koshi_a.globalX + 5,
                    _koshi_a.globalY + 5
                )

                //胸⇔腰②
                _line11 = new canvaslite.Line(
                    _mune_e.globalX + 5,
                    _mune_e.globalY + 5,
                    _koshi_b.globalX + 5,
                    _koshi_b.globalY + 5
                )
                
                //腰⇔ひざ①
                _line12 = new canvaslite.Line(
                    _koshi_c.globalX + 5,
                    _koshi_c.globalY + 5,
                    _hizaR_a.globalX + 5,
                    _hizaR_a.globalY + 5
                )

                //腰⇔ひざ②
                _line13 = new canvaslite.Line(
                    _koshi_d.globalX + 5,
                    _koshi_d.globalY + 5,
                    _hizaL_a.globalX + 5,
                    _hizaL_a.globalY + 5
                )

                //ひざ⇔足①
                _line14 = new canvaslite.Line(
                    _hizaR_b.globalX + 5,
                    _hizaR_b.globalY + 5,
                    _ashiR_a.globalX + 5,
                    _ashiR_a.globalY + 5
                )

                //ひざ⇔足②
                _line15 = new canvaslite.Line(
                    _hizaL_b.globalX + 5,
                    _hizaL_b.globalY + 5,
                    _ashiL_a.globalX + 5,
                    _ashiL_a.globalY + 5
                )

                _lineArray = [];
                for (let i=1; i<=15; i++) {
                    let _theLine = this["_line" + i];
                    _theLine.lineWidth = 2;
                    _theLine.name = "line" + i;
                    _lineArray.push(_theLine);
                    _canvas.addChild(_theLine);	
                }
            }

            //=====================
            // ShakeContainer Class
            //=====================
            class ShakeContainer extends canvaslite.Container {
                constructor() {
                    super();

                    this.__width = this.__height = undefined;

                    //アクセサにて外部からアクセス可能
                    this.__count = 0;
                    this.__moveX = 0;
                    this.__moveY = 0;
                    this.__limitR = 0;
                    this.__originX = 0;
                    this.__originY = 0;
                }

                savePos() {
                    this.__originX = this.x;
                    this.__originY = this.y;
                    this.__originR = this.rotate;
                }

                move(_x, _y) {
                    this.__count = 0;

                    //================
                    // _thePowerの確定
                    //================
                    var _theLimitDis = 500;
                    var _mouseDisX = _x - this.x - this.__width/2;
                    var _mouseDisY = _y - this.y - this.__height/2;
                    var _theDis = Math.sqrt(_mouseDisX*_mouseDisX + _mouseDisY*_mouseDisY);
                    if (_theDis < _theLimitDis) {
                        var _thePower = _theLimitDis - _theDis;
                    } else {
                        _thePower = 0;
                    }

                    //===========
                    // Rotate関係
                    //===========
                    var _theRotate = Math.atan2(_mouseDisY, _mouseDisX) + Math.PI;
                    this.__limitR = 180 * _theRotate / Math.PI -90;
                    if (this.__limitR > 90) {
                        this.__limitR -= 180;
                    }
                    this.__limitR *= 1.5; //大げさに動作させる為
                    this.rotate = this.__limitR;

                    //========================
                    // enterframe前の初期化
                    //========================
                    this.__moveX = Math.floor(_thePower * Math.cos(_theRotate)) / 2;
                    this.__moveY = Math.floor(_thePower * Math.sin(_theRotate)) / 2;
                }
                
                set width(_newValue) {
                    this.__width = _newValue;
                }
                get width() { return this.__width; }

                set height(_newValue) {
                    this.__height = _newValue;
                }
                get height() { return this.__height; }

                set count(_newValue) { this.__count = _newValue; }
                get count() { return this.__count; }
            
                set moveX(_newValue) { this.__moveX = _newValue; }
                get moveX() { return this.__moveX; }
                
                set moveY(_newValue) { this.__moveY = _newValue; }
                get moveY() { return this.__moveY; }

                set limitR(_newValue) { this.__limitR = _newValue; }
                get limitR() { return this.__limitR; }

                set originX(_newValue) { this.__originX = _newValue; }
                get originX() { return this.__originX; }

                set originY(_newValue) { this.__originY = _newValue; }
                get originY() { return this.__originY; }
            }
        </script>
        <style>
            body {
                background:#fff;
                margin:0;
                padding:0;
                overflow:hidden;
            }
        </style>
    </head>
    <body>
        <canvas id="myCanvas" width="640" height="640"></canvas>
    </body>
</html>
